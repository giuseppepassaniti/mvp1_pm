<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Progetti</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f1f5f9;
    }
    .project-card {
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .project-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
  </style>
</head>
<body class="text-slate-800">
  <div class="container mx-auto p-6">
    <header class="mb-6 text-center">
      <h1 class="text-3xl font-bold text-slate-900">Dashboard Progetti</h1>
      <p class="text-slate-600 mt-1">Carica il file <strong>Progetti.csv</strong> per iniziare.</p>
    </header>

    <div class="bg-white p-6 rounded-lg shadow-md text-center">
      <label for="progetti-upload" class="cursor-pointer bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 inline-block">
        <i data-lucide="upload" class="inline-block h-4 w-4 mr-2"></i>Carica Progetti.csv
      </label>
      <input type="file" id="progetti-upload" class="hidden" accept=".csv" />
    </div>

    <div id="projects-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mt-8"></div>
  </div>

  <script>
    const parseCurrency = str => parseFloat(str?.replace(/[.\u20AC\s]/g, '').replace(',', '.')) || 0;
    const parsePercentage = str => parseInt(str?.replace('%', ''), 10) || 0;
    const formatCurrency = val => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0 }).format(val);
    const statusInfo = {
      'In corso': 'bg-yellow-100 text-yellow-800',
      'Completato': 'bg-green-100 text-green-800',
      'Da approvare': 'bg-blue-100 text-blue-800',
      'Default': 'bg-slate-100 text-slate-800'
    };

    document.getElementById('progetti-upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        transform: value => value.trim(),
        complete: results => renderProjects(results.data),
        error: err => alert(`Errore: ${err.message}`)
      });
    });

    function renderProjects(data) {
      const container = document.getElementById('projects-container');
      const projects = data.map(row => {
        return {
          id: row['Id Progetto'],
          name: row['Nome Progetto'],
          client: row.Cliente,
          pm: row['PM responsabile'],
          status: row.Stato,
          budget: parseCurrency(row['Budget Iniziale']),
          costs: parseCurrency(row['Costi Sostenuti']),
          forecast: parseCurrency(row['Previsione Finale Costi']),
          progress: parsePercentage(row['% Avanzamento'])
        };
      });

      container.innerHTML = projects.map(p => {
        const badge = statusInfo[p.status] || statusInfo.Default;
        return `
          <div class="project-card bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-bold text-lg">${p.name}</h3>
              <span class="text-xs font-semibold px-2 py-1 rounded-full ${badge}">${p.status}</span>
            </div>
            <p class="text-sm text-slate-600 mb-3">${p.client} | PM: ${p.pm}</p>
            <div class="mb-4">
              <div class="flex justify-between text-sm mb-1"><span>Avanzamento</span><span>${p.progress}%</span></div>
              <div class="bg-slate-200 h-2 rounded-full">
                <div class="bg-blue-600 h-2 rounded-full" style="width: ${p.progress}%"></div>
              </div>
            </div>
            <div class="grid grid-cols-3 text-center text-sm mb-4">
              <div><p class="text-slate-500">Budget</p><p class="font-bold">${formatCurrency(p.budget)}</p></div>
              <div><p class="text-slate-500">Costi</p><p class="font-bold">${formatCurrency(p.costs)}</p></div>
              <div><p class="text-slate-500">Previsto</p><p class="font-bold">${formatCurrency(p.forecast)}</p></div>
            </div>
            <div class="text-right">
              <button class="text-blue-600 text-sm font-semibold hover:underline" onclick="alert('Dashboard futura: ${p.name}')">
                Vai alla dashboard
              </button>
            </div>
          </div>
        `;
      }).join('');

      lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
    });
  </script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
window.addEventListener("DOMContentLoaded", () => {
  fetch("data/progetti.csv")
    .then(response => response.text())
    .then(csvText => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          console.log("✅ Dati caricati da progetti.csv", results.data);
          if (typeof render === 'function') render(results.data);
        }
      });
    })
    .catch(err => {
      console.error("Errore nel caricamento di progetti.csv:", err);
    });
});
</script>

<div id='app' class='p-4'></div>

<script>
function render(data) {
  const container = document.getElementById("app");
  if (!container) return;

  if (data.length === 0) {
    container.innerHTML = "<p>Nessun dato disponibile.</p>";
    return;
  }

  const table = document.createElement("table");
  table.className = "table-auto border border-slate-300 bg-white text-sm w-full";
  const thead = document.createElement("thead");
  const tbody = document.createElement("tbody");

  // Header
  const headerRow = document.createElement("tr");
  Object.keys(data[0]).forEach(key => {
    const th = document.createElement("th");
    th.className = "border px-2 py-1 bg-slate-100";
    th.textContent = key;
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  // Body
  data.forEach(row => {
    const tr = document.createElement("tr");
    Object.values(row).forEach(val => {
      const td = document.createElement("td");
      td.className = "border px-2 py-1";
      td.textContent = val;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  table.appendChild(thead);
  table.appendChild(tbody);
  container.innerHTML = "";
  container.appendChild(table);
}
</script>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
window.addEventListener("DOMContentLoaded", () => {
  fetch("data/progetti.csv")
    .then(response => response.text())
    .then(csvText => {
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          console.log("✅ Dati caricati da progetti.csv", results.data);
          if (typeof render === 'function') render(results.data);
        }
      });
    })
    .catch(err => {
      console.error("Errore nel caricamento di progetti.csv:", err);
    });
});
</script>

</body>
</html>
